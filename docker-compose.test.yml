version: '3.8'

services:
  test-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=ecommerce_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_pass
    ports:
      - "5433:5432"

  test-redis:
    image: redis:7-alpine

  web:
    build: ./backend
    command: >
      sh -c "python manage.py wait_for_db &&
             python manage.py migrate &&
             python manage.py test --noinput"
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=postgresql://test_user:test_pass@test-db:5432/ecommerce_test
      - REDIS_URL=redis://test-redis:6379/0
      - DEBUG=False
      - SECRET_KEY=test-secret-key
    depends_on:
      - test-db
      - test-redis